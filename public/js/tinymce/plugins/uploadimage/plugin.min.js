tinymce.PluginManager.add('anhnvimage', function(editor, url) {
    // Add a button that opens a window
    editor.ui.registry.addButton('anhnvimage', {
        icon: "image",
        tooltip: "Insert/edit image",
        onAction: function () {
            var accept = tinymce.activeEditor.getParam('anhnv_accept_mime', 'image/x-png,image/gif,image/jpeg');
            var file = $('<input>').attr({type: 'file', name: 'imagefile', id: 'anhnvimage_file', accept: accept}).appendTo('body');
            file.trigger('click');
            
        }
    });

    $(document).on('change', '#anhnvimage_file', function() {
        var url = tinymce.activeEditor.getParam('anhnv_upload_url', 'upload');
        $.ajaxSetup({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            }
        });
        var content = tinymce.activeEditor.getContent();
       
        var file_data = $('#anhnvimage_file').prop('files')[0];
        var form_data = new FormData();
        form_data.append('imagefile', file_data);

        $.ajax({
            type:'POST',
            url: url,
            cache: false,
            contentType: false,
            processData: false,
            data: form_data,
            success:function(data) {
                if (data.data.file_path) {
                    tinymce.activeEditor.setContent(content + '<img src="' + data.data.file_path + '" style="width:100%">',{format : 'html'} );
                } else {
                    toastr.error(data.error);
                }
            }
        });

        $('#anhnvimage_file').remove();
    });

    return {
      getMetadata: function () {
        return  {
            name: 'Image anhnv plugin',
            url: ''
        };
      }
    };
});
